name: Run All R Scripts and Upload Plots

on:
  push:
    branches:
      - main
      - framework-files
      - feature/*
      - samoclay*

jobs:
  run-r:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - uses: actions/checkout@v3

      # Step 2: Set up R
      - uses: r-lib/actions/setup-r@v2

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          Rscript -e 'install.packages(c("ggplot2"), repos="https://cloud.r-project.org")'

      # Step 4: Run all .R scripts
      - name: Run all R scripts
        run: |
          mkdir -p plots
          for script in $(find . -maxdepth 1 -name "*.R"); do
            # Get the script basename without extension
            base=$(basename "$script" .R)
            echo "Running $script ..."
            # Run the script and tell it to save the plot as plots/<script-name>.png
            Rscript -e "source('$script'); ggsave('plots/${base}.png', plot=last_plot(), width=6, height=4)"
          done

      # Step 5: Upload all plots as artifacts
      - name: Upload plot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plots
          path: plots/*.png